<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comando Central - Chile</title>
    <style>
        :root { 
            --neon-green: #39ff14; 
            --dark-bg: #060806; 
            --army-red: #ff3b3b; 
            --fach-white: #ffffff; 
            --armada-blue: #1e90ff; 
            --gold: #ffd700;
            --glow-green: 0 0 15px rgba(57, 255, 20, 0.4);
            --glow-text: 0 0 8px rgba(57, 255, 20, 0.6);
        }

        body {
            background: var(--dark-bg);
            color: var(--neon-green);
            font-family: 'Consolas', 'Courier New', monospace;
            margin: 0;
            padding: 40px 20px;
            text-align: center;
            /* Efecto de l√≠neas de escaneo de monitor antiguo */
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                              linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
        }

        /* T√≠tulos con espaciado y glow */
        h2, h3 {
            letter-spacing: 6px;
            text-transform: uppercase;
            text-shadow: var(--glow-text);
            margin-bottom: 25px;
        }

        .box {
            background: rgba(10, 12, 10, 0.85);
            border: 1px solid rgba(57, 255, 20, 0.3);
            width: 100%;
            max-width: 700px;
            margin: 30px auto;
            padding: 35px;
            box-shadow: var(--glow-green);
            border-radius: 12px;
            backdrop-filter: blur(5px); /* Efecto Glass */
            transition: all 0.3s ease;
        }

        .box:hover {
            border-color: var(--neon-green);
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.2);
        }

        /* Inputs y Botones con estilo moderno */
        input, select, button {
            margin: 12px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            color: var(--neon-green);
            border: 1px solid rgba(57, 255, 20, 0.5);
            width: 95%;
            font-family: inherit;
            outline: none;
            border-radius: 4px;
            transition: 0.3s;
            letter-spacing: 1px;
        }

        input:focus {
            border-color: var(--neon-green);
            box-shadow: inset 0 0 8px rgba(57, 255, 20, 0.3);
        }

        button {
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: rgba(57, 255, 20, 0.05);
        }

        button:hover {
            background: var(--neon-green);
            color: black;
            box-shadow: 0 0 20px var(--neon-green);
        }

        /* Tarjetas de Soldado */
        .tarjeta { 
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 15px 0; 
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.03); 
            text-align: left;
            border-left: 5px solid gray;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 0 8px 8px 0;
        }

        .tarjeta:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(10px);
            box-shadow: -5px 0 15px rgba(255,255,255,0.1);
        }

        .insignia-img { 
            width: 55px; 
            height: 55px; 
            margin-right: 20px; 
            object-fit: contain;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));
        }

        /* Divisiones con su Glow respectivo */
        .Ejercito { border-left-color: var(--neon-green); }
        .FACH { border-left-color: var(--fach-white); }
        .BOE { border-left-color: var(--army-red); }
        .Armada { border-left-color: var(--armada-blue); }

        .admin-box { 
            border: 2px solid var(--army-red) !important; 
            box-shadow: 0 0 20px rgba(255, 59, 59, 0.2) !important;
            display: none; 
        }

        #panel, #listaPanel, #statsPanel, #logPanel { display: none; }
        
        /* Modal - Expediente */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
        }
        .modal-content {
            background: #080a08;
            border: 1px solid var(--neon-green);
            margin: 5% auto;
            padding: 40px;
            width: 85%;
            max-width: 550px;
            box-shadow: 0 0 40px rgba(57, 255, 20, 0.3);
            text-align: center;
            border-radius: 15px;
        }

        .medal-icon { 
            font-size: 35px; 
            margin: 10px; 
            display: inline-block; 
            filter: drop-shadow(0 0 8px var(--gold)); 
        }

        /* Estad√≠sticas */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            margin-top: 20px; 
        }
        .stat-item { 
            border: 1px solid rgba(57, 255, 20, 0.2); 
            padding: 15px; 
            font-size: 1em;
            background: rgba(57, 255, 20, 0.02);
            letter-spacing: 1px;
        }

        #logContent { 
            font-size: 0.9em; 
            color: var(--neon-green); 
            font-weight: bold; 
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
        }

        .last-con { font-size: 0.8em; color: #666; display: block; margin-top: 5px;}
        
        hr { border: 0; border-top: 1px solid rgba(57, 255, 20, 0.2); margin: 20px 0; }

    </style>
</head>
<body>

    <div class="box" id="loginBox">
        <h2>SISTEMA DE MANDO</h2>
        <p style="color:#666; margin-top:-15px; letter-spacing: 2px;">FUERZAS ARMADAS DE CHILE</p>
        <input id="regNombre" type="text" placeholder="Nombre de Operativo">
        <input id="email" type="email" placeholder="Correo Encriptado">
        <input id="password" type="password" placeholder="C√≥digo de Acceso">
        <select id="division">
            <option value="Ejercito">Ej√©rcito de Chile</option>
            <option value="FACH">Fuerza A√©rea (FACH)</option>
            <option value="Armada">Armada de Chile</option>
            <option value="BOE">Brigada de Operaciones Especiales (BOE)</option>
        </select>
        <button id="btnReg">Registrar Nuevo Soldado</button>
        <button id="btnLogin" style="border-color: var(--armada-blue); color: var(--armada-blue);">Ingresar al Terminal</button>
    </div>

    <div class="box" id="panel">
        <h3 id="welcome">IDENTIFICANDO...</h3>
        <p style="letter-spacing: 3px;">RANGO: <span id="rank" style="color:#fff"></span> | DIVISI√ìN: <span id="div" style="color:#fff"></span></p>
        <button id="btnLogout" style="width: auto; padding: 10px 30px; border-color: #444;">DESCONECTAR</button>
    </div>

    <div class="box" id="logPanel">
        <h3 style="color:var(--gold)">HISTORIAL DE MANDO</h3>
        <div id="logContent">Sincronizando registros...</div>
    </div>

    <div class="box" id="statsPanel">
        <h3>FUERZAS TOTALES</h3>
        <div class="stats-grid" id="statsContent"></div>
    </div>

    <div class="box admin-box" id="adminPanel">
        <h3 style="color:var(--army-red)">ALTO MANDO: GESTI√ìN</h3>
        <input id="targetEmail" placeholder="Correo del subalterno">
        <select id="newRankAdmin"></select>
        <input id="manualDays" type="number" placeholder="D√≠as de servicio manual">
        <button id="btnAscender" style="color:var(--army-red); border: 1px solid var(--army-red);">APLICAR MODIFICACI√ìN</button>
        <button id="btnBaja" style="background: #400; color: white; border: 1px solid red;">DAR DE BAJA PERMANENTE</button>
        <hr>
        <input id="targetMedalla" placeholder="Correo para condecoraci√≥n">
        <select id="selectMedalla">
            <option value="üéñÔ∏è">Medalla al Valor</option>
            <option value="üõ°Ô∏è">Escudo de Lealtad</option>
            <option value="‚≠ê">Estrella de Punter√≠a</option>
            <option value="üî•">Infante de √âlite</option>
        </select>
        <button id="btnMedalla" style="border-color: var(--gold); color: var(--gold);">OTORGAR CONDECORACI√ìN</button>
    </div>

    <div class="box" id="listaPanel">
        <h3>REGISTRO DE TROPAS</h3>
        <input type="text" id="searchBar" placeholder="üîç Buscar por nombre de operativo..." onkeyup="filtrarSoldados()">
        <div id="lista">Cargando base de datos central...</div>
    </div>

    <div id="modalExpediente" class="modal">
        <div class="modal-content">
            <h2 id="expNombre" style="color:var(--neon-green)">EXPEDIENTE</h2>
            <p id="expRangoDiv"></p>
            <p id="expAntiguedad" style="color:#888; font-style:italic;"></p>
            <p id="expUltimaCon" style="color:var(--armada-blue); font-size:0.9em;"></p>
            <hr>
            <h4 style="letter-spacing: 2px;">CONDECORACIONES ADQUIRIDAS</h4>
            <div id="expMedallas"></div>
            <br>
            <button onclick="cerrarModal()" style="border-color:#555">CERRAR EXPEDIENTE</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Tu configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBYfZSISbpVShSfEA70vY1bANiyy40uVP4",
        authDomain: "panel-chile.firebaseapp.com",
        projectId: "panel-chile",
        storageBucket: "panel-chile.firebasestorage.app",
        messagingSenderId: "124864601883",
        appId: "1:124864601883:web:839163be2060253f68bdbe"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const RANGOS_LISTA = ["Recluta", "Cabo 2¬∞", "Cabo 1¬∞", "Sargento 2¬∞", "Sargento 1¬∞", "Suboficial", "Suboficial Mayor", "Subteniente", "Teniente", "Capit√°n", "Mayor", "Teniente Coronel", "Coronel", "General de Brigada", "General de Divisi√≥n", "General en Jefe"];
    const sel = document.getElementById("newRankAdmin");
    RANGOS_LISTA.forEach(r => { let o = document.createElement("option"); o.value = r; o.textContent = r; sel.appendChild(o); });

    function formatearFecha(isoString) {
        if(!isoString) return "Nunca";
        const fecha = new Date(isoString);
        return fecha.toLocaleString('es-CL', { timeZone: 'America/Santiago' });
    }

    window.filtrarSoldados = function() {
        let input = document.getElementById('searchBar').value.toLowerCase();
        let tarjetas = document.getElementsByClassName('tarjeta');
        for (let i = 0; i < tarjetas.length; i++) {
            let nombre = tarjetas[i].getAttribute('data-nombre').toLowerCase();
            tarjetas[i].style.display = nombre.includes(input) ? "flex" : "none";
        }
    };

    window.verExpediente = async (email) => {
        const snap = await getDoc(doc(db, "usuarios", email));
        if (snap.exists()) {
            const x = snap.data();
            document.getElementById("expNombre").innerText = x.nombre || "Sin Nombre";
            document.getElementById("expRangoDiv").innerText = `${x.rango} | ${x.division}`;
            
            let diasBase = 0;
            if(x.fechaIngreso) {
                const fIngreso = new Date(x.fechaIngreso);
                const hoy = new Date();
                diasBase = Math.floor(Math.abs(hoy - fIngreso) / (1000 * 60 * 60 * 24));
            }
            const diasManuales = parseInt(x.antiguedadManual || 0);
            document.getElementById("expAntiguedad").innerText = `TIEMPO EN SERVICIO: ${diasBase + diasManuales} D√çAS`;
            document.getElementById("expUltimaCon").innerText = `√öLTIMA CONEXI√ìN: ${formatearFecha(x.ultimaConexion)}`;

            let meds = "";
            if(x.medallas) x.medallas.forEach(m => meds += `<span class="medal-icon">${m}</span>`);
            document.getElementById("expMedallas").innerHTML = meds || "Sin condecoraciones registradas.";
            document.getElementById("modalExpediente").style.display = "block";
        }
    };

    window.cerrarModal = () => document.getElementById("modalExpediente").style.display = "none";

    async function registrarAccion(mensaje) {
        const ahora = new Date();
        const fechaHora = ahora.toLocaleString('es-CL', { timeZone: 'America/Santiago' });
        await setDoc(doc(db, "config", "logs"), { ultimaAccion: `[${fechaHora}] ${mensaje}` });
        cargarLogs();
    }

    async function cargarLogs() {
        const snap = await getDoc(doc(db, "config", "logs"));
        if(snap.exists()) document.getElementById("logContent").innerText = snap.data().ultimaAccion;
    }

    async function cargarDatos() {
        const qs = await getDocs(collection(db, "usuarios"));
        let h = "";
        let counts = { Ejercito: 0, FACH: 0, Armada: 0, BOE: 0, Total: 0 };
        const mapa = { "Cabo 2¬∞": "cabo_2.png", "Cabo 1¬∞": "cabo_1.png", "Sargento 2¬∞": "sargento_2.png", "Sargento 1¬∞": "sargento_1.png", "General en Jefe": "general_en_jefe.png", "Suboficial Mayor": "subof_mayor.png" };

        qs.forEach(d => {
            const x = d.data();
            const r = x.rango || "Recluta";
            counts[x.division] = (counts[x.division] || 0) + 1;
            counts.Total++;
            let img = mapa[r] || r.toLowerCase().trim().replace(/ /g, "_").replace("√≠", "i").replace("¬∞", "") + ".png";
            const fCon = x.ultimaConexion ? formatearFecha(x.ultimaConexion).split(",")[0] : "---";

            h += `<div class="tarjeta ${x.division}" data-nombre="${x.nombre}" onclick="verExpediente('${x.email}')">
                <img src="img/${img}" class="insignia-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2592/2592201.png'">
                <div>
                    <b style="color:white; font-size:1.1em; letter-spacing:1px;">${x.nombre || 'An√≥nimo'}</b><br>
                    <small style="color:var(--neon-green)">${r.toUpperCase()} [${x.division}]</small><br>
                    <span class="last-con">√öltimo acceso: ${fCon}</span>
                </div>
                <div style="margin-left:auto; text-align:right;">
                    ${x.medallas ? x.medallas[0] || '' : ''} 
                    <br><small style="color:var(--neon-green); font-weight:bold;">‚óè ONLINE</small>
                </div>
            </div>`;
        });
        document.getElementById("lista").innerHTML = h;
        document.getElementById("statsContent").innerHTML = `
            <div class="stat-item">EJ√âRCITO: ${counts.Ejercito}</div><div class="stat-item">FACH: ${counts.FACH}</div>
            <div class="stat-item">ARMADA: ${counts.Armada}</div><div class="stat-item">BOE: ${counts.BOE}</div>
            <div class="stat-item" style="grid-column: span 2; border-color: var(--neon-green); font-weight:bold; color:white;">FUERZA OPERATIVA TOTAL: ${counts.Total}</div>`;
        cargarLogs();
    }

    let nombreUsuarioActual = "";

    document.getElementById("btnReg").onclick = async () => {
        const email = document.getElementById("email").value;
        const pass = document.getElementById("password").value;
        const nom = document.getElementById("regNombre").value;
        const div = document.getElementById("division").value;
        if(!nom || !email || !pass) return alert("Faltan datos");
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            const hoy = new Date().toISOString();
            await setDoc(doc(db, "usuarios", email), { email, nombre: nom, rango: "Recluta", division: div, medallas: [], fechaIngreso: hoy, antiguedadManual: 0, ultimaConexion: hoy });
            alert("Soldado registrado en la base de datos."); cargarDatos();
        } catch(e) { alert(e.message); }
    };

    document.getElementById("btnLogin").onclick = async () => {
        const email = document.getElementById("email").value;
        const pass = document.getElementById("password").value;
        try { await signInWithEmailAndPassword(auth, email, pass); } catch(e) { alert("Error de credenciales"); }
    };

    document.getElementById("btnLogout").onclick = () => signOut(auth).then(() => location.reload());

    document.getElementById("btnAscender").onclick = async () => {
        const email = document.getElementById("targetEmail").value;
        const nuevo = document.getElementById("newRankAdmin").value;
        const diasExtra = document.getElementById("manualDays").value || 0;
        try { 
            const tSnap = await getDoc(doc(db, "usuarios", email));
            const nombreT = tSnap.exists() ? (tSnap.data().nombre || email) : email;
            await updateDoc(doc(db, "usuarios", email), { rango: nuevo, antiguedadManual: parseInt(diasExtra) }); 
            registrarAccion(`${nombreUsuarioActual} modific√≥ perfil de ${nombreT} -> ${nuevo}`);
            alert("Datos actualizados correctamente."); cargarDatos(); 
        } catch(e) { alert("Error al actualizar"); }
    };

    document.getElementById("btnMedalla").onclick = async () => {
        const email = document.getElementById("targetMedalla").value;
        const med = document.getElementById("selectMedalla").value;
        if(!email) return alert("Ingrese correo del destinatario");
        try {
            const tSnap = await getDoc(doc(db, "usuarios", email));
            const nombreT = tSnap.exists() ? (tSnap.data().nombre || email) : email;
            await updateDoc(doc(db, "usuarios", email), { medallas: arrayUnion(med) });
            registrarAccion(`${nombreUsuarioActual} condecor√≥ a ${nombreT} con ${med}`);
            alert("Medalla otorgada!"); cargarDatos();
        } catch(e) { alert(e.message); }
    };

    document.getElementById("btnBaja").onclick = async () => {
        const email = document.getElementById("targetEmail").value;
        if(!email) return alert("Ingrese correo");
        try {
            const tSnap = await getDoc(doc(db, "usuarios", email));
            const nombreT = tSnap.exists() ? (tSnap.data().nombre || email) : email;
            if(confirm(`¬øConfirmar baja definitiva de ${nombreT}?`)) {
                await deleteDoc(doc(db, "usuarios", email)); 
                registrarAccion(`${nombreUsuarioActual} elimin√≥ de las fuerzas a ${nombreT}`);
                alert("Soldado eliminado de la base de datos."); cargarDatos(); 
            }
        } catch(e) { alert("Error"); }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userRef = doc(db, "usuarios", user.email);
            const snap = await getDoc(userRef);
            if (snap.exists()) {
                const d = snap.data();
                nombreUsuarioActual = d.nombre || user.email;
                await updateDoc(userRef, { ultimaConexion: new Date().toISOString() });

                document.getElementById("loginBox").style.display = "none";
                ["panel", "listaPanel", "statsPanel"].forEach(id => document.getElementById(id).style.display = "block");
                
                document.getElementById("welcome").innerText = "OPERATIVO: " + nombreUsuarioActual.toUpperCase();
                document.getElementById("rank").innerText = d.rango;
                document.getElementById("div").innerText = d.division;
                
                const r = d.rango.toLowerCase().trim();
                const jerarquia = ["capit√°n", "capitan", "mayor", "teniente coronel", "coronel", "general de brigada", "general de divisi√≥n", "general en jefe"];
                
                if (jerarquia.includes(r)) {
                    document.getElementById("adminPanel").style.display = "block";
                    document.getElementById("logPanel").style.display = "block";
                }
                cargarDatos();
            }
        }
    });
</script>
</body>
</html>
