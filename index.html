<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE MANDO T√ÅCTICO - CHILE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root { 
            --tactical-green: #4df24d; 
            --dim-green: rgba(77, 242, 77, 0.15);
            --army-dark: #020602;
            --alert-amber: #ffb400;
            --danger-red: #ff3b3b;
            --gold: #ffd700;
            --tech-blue: #00f2ff;
            --glass-bg: rgba(5, 10, 5, 0.95);
        }

        body {
            background: var(--army-dark);
            color: var(--tactical-green);
            font-family: 'Share Tech Mono', monospace;
            margin: 0;
            padding: 0;
            background-image: radial-gradient(circle at center, #0a1a0a 0%, #020602 100%);
            overflow-x: hidden;
        }

        .main-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* --- DASHBOARD SUPERIOR --- */
        .stats-banner {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: rgba(0, 20, 0, 0.6);
            border: 1px solid var(--dim-green);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 180px;
            border-left: 4px solid var(--tactical-green);
        }

        .stat-card.alto-mando { border-left-color: var(--danger-red); }
        .stat-card.operativos { border-left-color: var(--tactical-green); }
        .stat-card.reclutas { border-left-color: var(--tech-blue); }

        .stat-num { font-size: 24px; font-weight: bold; color: white; }
        .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* --- CAJAS DE INTERFAZ --- */
        .box {
            background: var(--glass-bg);
            border: 1px solid var(--dim-green);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            position: relative;
        }

        .box::before {
            content: ""; position: absolute; top: 0; left: 0; width: 10px; height: 10px;
            border-top: 2px solid var(--tactical-green); border-left: 2px solid var(--tactical-green);
        }

        /* --- REJILLA DE TARJETAS (SIN FOTO) --- */
        .grid-tropas {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .tarjeta-tactica {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(77, 242, 77, 0.1);
            padding: 20px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
            overflow: hidden;
        }

        .tarjeta-tactica:hover {
            background: var(--dim-green);
            transform: translateY(-5px) translateX(5px);
            border-color: var(--tactical-green);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }

        /* ICONO CSS EN LUGAR DE FOTO */
        .icon-tactical {
            width: 50px;
            height: 50px;
            border: 2px solid var(--tactical-green);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: rgba(77, 242, 77, 0.1);
            flex-shrink: 0;
        }

        .icon-tactical::after {
            content: "‚ñ≤";
            font-size: 20px;
            color: var(--tactical-green);
            text-shadow: 0 0 5px var(--tactical-green);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(77, 242, 77, 0.2);
            padding-bottom: 5px;
        }

        .card-id { color: var(--tech-blue); font-weight: bold; }
        .card-rank { color: #aaa; text-transform: uppercase; }

        .card-body { display: flex; gap: 15px; align-items: flex-start; }

        .card-info b { font-size: 18px; color: white; display: block; margin-bottom: 10px; }
        .info-row { font-size: 11px; display: grid; grid-template-columns: 80px 1fr; margin-bottom: 4px; }
        .info-label { color: #666; }
        .info-val { color: var(--tactical-green); text-transform: uppercase; }

        .card-footer {
            margin-top: 15px;
            text-align: right;
            font-size: 10px;
            letter-spacing: 1px;
        }

        /* --- FORMULARIOS --- */
        input, select, button {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--dim-green);
            color: var(--tactical-green);
            padding: 12px;
            margin: 8px 0;
            width: 100%;
            font-family: inherit;
            outline: none;
        }

        button { border: 1px solid var(--tactical-green); cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: var(--tactical-green); color: black; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: var(--tactical-green); box-shadow: 0 0 8px var(--tactical-green); }
        .offline { background: var(--danger-red); }

        #adminPanel, #logPanel, #panelPrincipal { display: none; }

        /* MODAL */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #050a05; border: 1px solid var(--tactical-green);
            margin: 10% auto; padding: 30px; width: 90%; max-width: 500px;
        }
    </style>
</head>
<body>

<div class="main-container">

    <div id="loginBox" class="box" style="max-width: 500px; margin: 100px auto;">
        <h2 style="text-align: center; letter-spacing: 5px;">ACCESS_TERMINAL</h2>
        <input id="regNombre" type="text" placeholder="ID_OPERATIVO">
        <input id="email" type="email" placeholder="CORREO_ENCRIPTADO">
        <input id="password" type="password" placeholder="ACCESS_CODE">
        <select id="division">
            <option value="Ejercito">EJ√âRCITO DE CHILE</option>
            <option value="FACH">FUERZA A√âREA (FACH)</option>
            <option value="Armada">ARMADA DE CHILE</option>
            <option value="BOE">BRIGADA OP. ESPECIALES</option>
        </select>
        <select id="especialidad">
            <option value="Fusilero">FUSILERO</option>
            <option value="Oficial de Campo">OFICIAL DE CAMPO</option>
            <option value="Piloto">PILOTO</option>
            <option value="Inteligencia">INTELIGENCIA</option>
            <option value="M√©dico">M√âDICO T√ÅCTICO</option>
        </select>
        <button id="btnReg">REGISTRAR NUEVO OPERATIVO</button>
        <button id="btnLogin" style="border-color: var(--alert-amber); color: var(--alert-amber);">INGRESAR AL SISTEMA</button>
    </div>

    <div id="panelPrincipal">
        <div class="stats-banner">
            <div class="stat-card"><div class="stat-num" id="countTotal">0</div><div class="stat-label">Efectivos<br>Totales</div></div>
            <div class="stat-card alto-mando"><div class="stat-num" id="countMando">0</div><div class="stat-label">Alto<br>Mando</div></div>
            <div class="stat-card operativos"><div class="stat-num" id="countOps">0</div><div class="stat-label">Operativos<br>Activos</div></div>
            <div class="stat-card reclutas"><div class="stat-num" id="countRec">0</div><div class="stat-label">Nuevos<br>Reclutas</div></div>
        </div>

        <div class="box">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="welcome">USUARIO: IDENTIFICANDO...</h3>
                <button id="btnLogout" style="width: auto; padding: 5px 15px;">SALIR</button>
            </div>
        </div>

        <div id="adminPanel" class="box" style="border-color: var(--danger-red);">
            <h3 style="color: var(--danger-red);">COMMAND ADMIN</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input id="targetEmail" placeholder="CORREO DEL SOLDADO">
                <select id="newRankAdmin"></select>
                <input id="manualDays" type="number" placeholder="+ D√çAS">
                <button id="btnAscender">APLICAR CAMBIOS</button>
            </div>
        </div>

        <div class="box">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3>REGISTRO T√ÅCTICO</h3>
                <input type="text" id="searchBar" placeholder="üîç BUSCAR..." onkeyup="filtrarSoldados()" style="width: 250px; margin: 0;">
            </div>
            <div id="lista" class="grid-tropas"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBYfZSISbpVShSfEA70vY1bANiyy40uVP4",
        authDomain: "panel-chile.firebaseapp.com",
        projectId: "panel-chile",
        storageBucket: "panel-chile.firebasestorage.app",
        messagingSenderId: "124864601883",
        appId: "1:124864601883:web:839163be2060253f68bdbe"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    window.playHoverSound = () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.01, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.05);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.05);
    };

    const RANGOS_LISTA = ["Recluta", "Cabo 2¬∞", "Cabo 1¬∞", "Sargento 2¬∞", "Sargento 1¬∞", "Suboficial", "Suboficial Mayor", "Subteniente", "Teniente", "Capit√°n", "Mayor", "Teniente Coronel", "Coronel", "General de Brigada", "General de Divisi√≥n", "General en Jefe"];

    async function cargarDatos() {
        const qs = await getDocs(collection(db, "usuarios"));
        let h = "";
        let counts = { Total: 0, Mando: 0, Ops: 0, Rec: 0 };
        
        qs.forEach(d => {
            const x = d.data();
            counts.Total++;
            const r = x.rango || "Recluta";
            if (r.includes("General") || r.includes("Coronel")) counts.Mando++;
            else if (r === "Recluta") counts.Rec++;
            else counts.Ops++;

            const status = (new Date() - new Date(x.ultimaConexion)) / 60000 < 10 ? "online" : "offline";
            const colorDivision = x.division === 'Ejercito' ? '#4df24d' : (x.division === 'FACH' ? '#fff' : (x.division === 'Armada' ? '#00f2ff' : '#ff3b3b'));

            h += `
            <div class="tarjeta-tactica" onmouseenter="playHoverSound()" onclick="verExpediente('${x.email}')">
                <div class="card-header">
                    <span class="card-rank">${r}</span>
                    <span class="card-id">#${x.email.split('@')[0].toUpperCase()}</span>
                </div>
                <div class="card-body">
                    <div class="icon-tactical" style="border-color: ${colorDivision}; color: ${colorDivision};"></div>
                    <div class="card-info">
                        <b>${x.nombre}</b>
                        <div class="info-row"><span class="info-label">Especialidad</span><span class="info-val">${x.especialidad || 'FUSILERO'}</span></div>
                        <div class="info-row"><span class="info-label">Unidad</span><span class="info-val" style="color:${colorDivision}">${x.division}</span></div>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="status-dot ${status}"></span> ${status.toUpperCase()}
                </div>
            </div>`;
        });

        document.getElementById("lista").innerHTML = h;
        document.getElementById("countTotal").innerText = counts.Total;
        document.getElementById("countMando").innerText = counts.Mando;
        document.getElementById("countOps").innerText = counts.Ops;
        document.getElementById("countRec").innerText = counts.Rec;
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "usuarios", user.email));
            if (snap.exists()) {
                const d = snap.data();
                document.getElementById("loginBox").style.display = "none";
                document.getElementById("panelPrincipal").style.display = "block";
                document.getElementById("welcome").innerText = "OPERATIVO: " + d.nombre.toUpperCase();
                const jerarquia = ["capit√°n", "mayor", "coronel", "general de brigada", "general de divisi√≥n", "general en jefe"];
                if (jerarquia.includes(d.rango.toLowerCase())) document.getElementById("adminPanel").style.display = "block";
                cargarDatos();
            }
        }
    });

    // (L√≥gica de registro y login igual a la anterior...)
    document.getElementById("btnReg").onclick = async () => {
        const email = document.getElementById("email").value;
        const pass = document.getElementById("password").value;
        const nom = document.getElementById("regNombre").value;
        const div = document.getElementById("division").value;
        const esp = document.getElementById("especialidad").value;
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "usuarios", email), { email, nombre: nom, rango: "Recluta", division: div, especialidad: esp, ultimaConexion: new Date().toISOString() });
            location.reload();
        } catch(e) { alert(e.message); }
    };

    document.getElementById("btnLogin").onclick = async () => {
        const email = document.getElementById("email").value;
        const pass = document.getElementById("password").value;
        try { await signInWithEmailAndPassword(auth, email, pass); } catch(e) { alert("ERROR"); }
    };
    document.getElementById("btnLogout").onclick = () => signOut(auth).then(() => location.reload());

    window.filtrarSoldados = function() {
        let input = document.getElementById('searchBar').value.toLowerCase();
        let tarjetas = document.getElementsByClassName('tarjeta-tactica');
        for (let t of tarjetas) t.style.display = t.innerText.toLowerCase().includes(input) ? "block" : "none";
    };
</script>
</body>
</html>
