<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE MANDO T√ÅCTICO - CHILE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root { 
            --tactical-green: #4df24d; 
            --dim-green: rgba(77, 242, 77, 0.15);
            --army-dark: #020602;
            --alert-amber: #ffb400;
            --danger-red: #ff3b3b;
            --gold: #ffd700;
            --tech-blue: #00f2ff;
            --glass-bg: rgba(5, 10, 10, 0.95);
        }

        body {
            background: var(--army-dark);
            color: var(--tactical-green);
            font-family: 'Share Tech Mono', monospace;
            margin: 0; padding: 0;
            background-image: radial-gradient(circle at center, #0a1a0a 0%, #020602 100%);
            overflow-x: hidden;
        }

        .main-container { padding: 20px; max-width: 1400px; margin: 0 auto; }

        /* DASHBOARD SUPERIOR */
        .stats-banner { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .stat-card {
            background: rgba(0, 20, 0, 0.6); border: 1px solid var(--dim-green);
            padding: 10px 20px; display: flex; align-items: center; gap: 15px;
            min-width: 180px; border-left: 4px solid var(--tactical-green);
        }
        .stat-num { font-size: 24px; font-weight: bold; color: white; }
        .stat-label { font-size: 10px; text-transform: uppercase; }

        /* CAJAS HUD */
        .box {
            background: var(--glass-bg); border: 1px solid var(--dim-green);
            padding: 25px; margin-bottom: 25px; position: relative;
        }
        .box::before {
            content: ""; position: absolute; top: 0; left: 0; width: 10px; height: 10px;
            border-top: 2px solid var(--tactical-green); border-left: 2px solid var(--tactical-green);
        }

        /* REJILLA DE TARJETAS */
        .grid-tropas {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;
        }
        .tarjeta-tactica {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(77, 242, 77, 0.1);
            padding: 15px; position: relative; transition: 0.3s; cursor: pointer;
        }
        .tarjeta-tactica:hover { background: var(--dim-green); transform: scale(1.02); }

        /* ICONO CSS */
        .icon-tactical {
            width: 45px; height: 45px; border: 1px solid var(--tactical-green);
            display: flex; align-items: center; justify-content: center;
            background: rgba(77, 242, 77, 0.1);
        }
        .icon-tactical::after { content: "‚ñ≤"; font-size: 18px; }

        .card-header { display: flex; justify-content: space-between; font-size: 10px; border-bottom: 1px solid rgba(77, 242, 77, 0.2); margin-bottom: 10px; }
        .card-body { display: flex; gap: 12px; }
        .info-row { font-size: 11px; display: grid; grid-template-columns: 85px 1fr; margin-top: 3px; }
        .info-label { color: #666; }
        .info-val { color: var(--tactical-green); text-transform: uppercase; }

        /* FORMULARIOS */
        input, select, button {
            background: rgba(0, 0, 0, 0.8); border: 1px solid var(--dim-green);
            color: var(--tactical-green); padding: 10px; margin: 5px 0; width: 100%;
            font-family: inherit; outline: none;
        }
        button { border: 1px solid var(--tactical-green); cursor: pointer; font-weight: bold; }
        button:hover { background: var(--tactical-green); color: black; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: var(--tactical-green); box-shadow: 0 0 5px var(--tactical-green); }
        .offline { background: var(--danger-red); }

        /* MODAL */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
        }
        .modal-content {
            background: #050a0a; border: 1px solid var(--tactical-green);
            margin: 10% auto; padding: 30px; width: 90%; max-width: 400px; text-align: center;
        }

        #adminPanel, #panelPrincipal { display: none; }
    </style>
</head>
<body>

<div class="main-container">

    <div id="loginBox" class="box" style="max-width: 400px; margin: 100px auto;">
        <h2 style="text-align: center; letter-spacing: 3px;">TERMINAL_SISTEMA</h2>
        <input id="regNombre" type="text" placeholder="NOMBRE COMPLETO">
        <input id="email" type="email" placeholder="EMAIL">
        <input id="password" type="password" placeholder="PASSWORD">
        <select id="division">
            <option value="Ejercito">EJ√âRCITO</option>
            <option value="FACH">FACH</option>
            <option value="Armada">ARMADA</option>
            <option value="BOE">BOE</option>
        </select>
        <button id="btnReg">REGISTRAR</button>
        <button id="btnLogin" style="color: var(--alert-amber); border-color: var(--alert-amber);">ENTRAR</button>
    </div>

    <div id="panelPrincipal">
        <div class="stats-banner">
            <div class="stat-card"><div><div class="stat-num" id="countTotal">0</div><div class="stat-label">Efectivos</div></div></div>
            <div class="stat-card" style="border-left-color: var(--danger-red);"><div><div class="stat-num" id="countMando">0</div><div class="stat-label">Alto Mando</div></div></div>
        </div>

        <div class="box">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="welcome">IDENTIFICANDO...</h3>
                <button id="btnLogout" style="width: auto; padding: 5px 15px;">LOGOUT</button>
            </div>
        </div>

        <div id="adminPanel" class="box" style="border-color: var(--danger-red);">
            <h3 style="color: var(--danger-red);">ADMINISTRACI√ìN DE RANGOS</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <select id="userSelectAdmin">
                    <option value="">SELECCIONAR SOLDADO...</option>
                </select>
                <select id="newRankAdmin">
                    <option value="">NUEVO RANGO...</option>
                </select>
                <input id="manualDays" type="number" placeholder="+ D√çAS ANTIG√úEDAD">
                <button id="btnApplyAdmin">ACTUALIZAR EXPEDIENTE</button>
            </div>
        </div>

        <div class="box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>REGISTRO T√ÅCTICO</h3>
                <input type="text" id="searchBar" placeholder="üîç FILTRAR NOMBRE..." onkeyup="filtrarSoldados()" style="width: 200px; margin: 0;">
            </div>
            <div id="lista" class="grid-tropas"></div>
        </div>
    </div>
</div>

<div id="modalExpediente" class="modal">
    <div class="modal-content">
        <div id="perfilIcon" class="icon-tactical" style="margin: 0 auto 15px; width: 60px; height: 60px;"></div>
        <h2 id="expNombre"></h2>
        <p id="expRangoDiv" style="color: var(--alert-amber);"></p>
        <hr style="border: 0; border-top: 1px solid var(--dim-green); margin: 15px 0;">
        <div style="text-align: left; font-size: 13px;">
            <p>üí∞ <span style="color: #666;">SALARIO:</span> <span id="expSueldo" style="color: var(--gold);"></span></p>
            <p>‚è≥ <span style="color: #666;">SERVICIO:</span> <span id="expDias" style="color: white;"></span></p>
            <p>üì° <span style="color: #666;">√öLTIMA CONEXI√ìN:</span> <br><span id="expCon" style="font-size: 10px;"></span></p>
        </div>
        <button onclick="cerrarModal()" style="margin-top: 20px;">CERRAR</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBYfZSISbpVShSfEA70vY1bANiyy40uVP4",
        authDomain: "panel-chile.firebaseapp.com",
        projectId: "panel-chile",
        storageBucket: "panel-chile.firebasestorage.app",
        messagingSenderId: "124864601883",
        appId: "1:124864601883:web:839163be2060253f68bdbe"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const RANGOS = ["Recluta", "Cabo 2¬∞", "Cabo 1¬∞", "Sargento 2¬∞", "Sargento 1¬∞", "Suboficial", "Suboficial Mayor", "Subteniente", "Teniente", "Capit√°n", "Mayor", "Teniente Coronel", "Coronel", "General de Brigada", "General de Divisi√≥n", "General en Jefe"];
    
    // TABLA DE SUELDOS ACTUALIZADA SEG√öN SOLICITUD
    const SUELDOS = {
        "Recluta": "$3.500",
        "Cabo 2¬∞": "$3.800",
        "Cabo 1¬∞": "$3.800",
        "Sargento 2¬∞": "$4.000",
        "Sargento 1¬∞": "$4.300",
        "Suboficial": "$4.600",
        "Suboficial Mayor": "$5.000",
        "Subteniente": "$5.300",
        "Teniente": "$5.700",
        "Capit√°n": "$6.200",
        "Mayor": "$6.800",
        "Teniente Coronel": "$7.500",
        "Coronel": "$8.500",
        "General de Brigada": "$9.500",
        "General de Divisi√≥n": "$11.000",
        "General en Jefe": "$13.000"
    };

    const selRank = document.getElementById("newRankAdmin");
    RANGOS.forEach(r => { let o = document.createElement("option"); o.value = r; o.textContent = r; selRank.appendChild(o); });

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    window.playHoverSound = () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.01, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.05);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.05);
    };

    async function cargarDatos() {
        const qs = await getDocs(collection(db, "usuarios"));
        let h = "";
        let cTotal = 0, cMando = 0;
        const userSelect = document.getElementById("userSelectAdmin");
        userSelect.innerHTML = '<option value="">SELECCIONAR SOLDADO...</option>';

        qs.forEach(d => {
            const x = d.data();
            cTotal++;
            if (x.rango.includes("General") || x.rango === "Coronel") cMando++;

            let opt = document.createElement("option");
            opt.value = d.id;
            opt.textContent = x.nombre.toUpperCase();
            userSelect.appendChild(opt);

            const color = x.division === 'Ejercito' ? '#4df24d' : (x.division === 'FACH' ? '#fff' : (x.division === 'Armada' ? '#00f2ff' : '#ff3b3b'));
            const status = (new Date() - new Date(x.ultimaConexion)) / 60000 < 15 ? "online" : "offline";

            h += `
            <div class="tarjeta-tactica" onmouseenter="playHoverSound()" onclick="verExpediente('${d.id}')">
                <div class="card-header"><span>${x.rango.toUpperCase()}</span><span>#${d.id.split('@')[0].toUpperCase()}</span></div>
                <div class="card-body">
                    <div class="icon-tactical" style="border-color:${color}; color:${color}"></div>
                    <div style="flex:1">
                        <b style="color:white; font-size:16px;">${x.nombre}</b>
                        <div class="info-row"><span class="info-label">DIVISI√ìN</span><span class="info-val" style="color:${color}">${x.division}</span></div>
                        <div class="info-row"><span class="info-label">ESTADO</span><span class="info-val"><span class="status-dot ${status}"></span>${status}</span></div>
                    </div>
                </div>
            </div>`;
        });
        document.getElementById("lista").innerHTML = h;
        document.getElementById("countTotal").innerText = cTotal;
        document.getElementById("countMando").innerText = cMando;
    }

    window.verExpediente = async (id) => {
        const snap = await getDoc(doc(db, "usuarios", id));
        if (snap.exists()) {
            const x = snap.data();
            const dias = Math.floor((new Date() - new Date(x.fechaIngreso)) / 86400000) + (x.antiguedadManual || 0);
            
            document.getElementById("expNombre").innerText = x.nombre.toUpperCase();
            document.getElementById("expRangoDiv").innerText = `${x.rango} | UNIDAD ${x.division.toUpperCase()}`;
            document.getElementById("expSueldo").innerText = `${SUELDOS[x.rango] || "$3.500"} USD/H`;
            document.getElementById("expDias").innerText = `${dias} D√çAS EN ACTIVO`;
            document.getElementById("expCon").innerText = new Date(x.ultimaConexion).toLocaleString();
            
            document.getElementById("modalExpediente").style.display = "block";
        }
    };

    window.cerrarModal = () => document.getElementById("modalExpediente").style.display = "none";

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "usuarios", user.email));
            if (snap.exists()) {
                const d = snap.data();
                document.getElementById("loginBox").style.display = "none";
                document.getElementById("panelPrincipal").style.display = "block";
                document.getElementById("welcome").innerText = "OPERATIVO: " + d.nombre.toUpperCase();
                if (["Coronel", "General de Brigada", "General de Divisi√≥n", "General en Jefe"].includes(d.rango)) {
                    document.getElementById("adminPanel").style.display = "block";
                }
                updateDoc(doc(db, "usuarios", user.email), { ultimaConexion: new Date().toISOString() });
                cargarDatos();
            }
        }
    });

    document.getElementById("btnReg").onclick = async () => {
        const email = document.getElementById("email").value, pass = document.getElementById("password").value, nom = document.getElementById("regNombre").value, div = document.getElementById("division").value;
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "usuarios", email), { nombre: nom, email, rango: "Recluta", division: div, fechaIngreso: new Date().toISOString(), antiguedadManual: 0, ultimaConexion: new Date().toISOString() });
            location.reload();
        } catch(e) { alert(e.message); }
    };

    document.getElementById("btnLogin").onclick = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value); } catch(e) { alert("ERROR ACCESO"); }
    };

    document.getElementById("btnApplyAdmin").onclick = async () => {
        const id = document.getElementById("userSelectAdmin").value, r = document.getElementById("newRankAdmin").value, d = document.getElementById("manualDays").value;
        if (!id || !r) return alert("COMPLETA LOS CAMPOS");
        await updateDoc(doc(db, "usuarios", id), { rango: r, antiguedadManual: parseInt(d) || 0 });
        alert("EXPEDIENTE ACTUALIZADO"); cargarDatos();
    };

    document.getElementById("btnLogout").onclick = () => signOut(auth).then(() => location.reload());

    window.filtrarSoldados = () => {
        let val = document.getElementById('searchBar').value.toLowerCase();
        let cards = document.getElementsByClassName('tarjeta-tactica');
        for (let c of cards) c.style.display = c.innerText.toLowerCase().includes(val) ? "block" : "none";
    };
</script>
</body>
</html>
