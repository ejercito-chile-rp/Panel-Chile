<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE MANDO T√ÅCTICO - CHILE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root { 
            --tactical-green: #4df24d; 
            --dim-green: rgba(77, 242, 77, 0.15);
            --army-dark: #020602;
            --alert-amber: #ffb400;
            --danger-red: #ff3b3b;
            --glass-bg: rgba(5, 10, 5, 0.95);
        }

        body {
            background: var(--army-dark);
            color: var(--tactical-green);
            font-family: 'Share Tech Mono', monospace;
            margin: 0; padding: 0;
            background-image: radial-gradient(circle at center, #0a1a0a 0%, #020602 100%);
        }

        .main-container { padding: 20px; max-width: 1300px; margin: 0 auto; }

        /* HEADER STATS */
        .stats-banner { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-card {
            background: rgba(0, 20, 0, 0.6); border: 1px solid var(--dim-green);
            padding: 10px 20px; border-left: 4px solid var(--tactical-green); min-width: 150px;
        }
        .stat-num { font-size: 22px; font-weight: bold; color: white; }
        .stat-label { font-size: 10px; text-transform: uppercase; color: var(--tactical-green); }

        /* CAJAS PRINCIPALES */
        .box {
            background: var(--glass-bg); border: 1px solid var(--dim-green);
            padding: 20px; margin-bottom: 20px; position: relative;
        }

        /* GRID DE SOLDADOS */
        .grid-tropas {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }
        .tarjeta-tactica {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(77, 242, 77, 0.1);
            padding: 15px; cursor: pointer; transition: 0.2s;
        }
        .tarjeta-tactica:hover { background: var(--dim-green); border-color: var(--tactical-green); }

        .icon-rank {
            width: 45px; height: 45px; border: 1px solid var(--tactical-green);
            display: flex; align-items: center; justify-content: center; background: rgba(77,242,77,0.1);
        }

        /* ADMIN PANEL - ROJO */
        #adminPanel { border: 1px solid var(--danger-red); display: none; }
        .admin-title { color: var(--danger-red); margin-top: 0; font-size: 14px; letter-spacing: 2px; }

        /* FORMULARIOS */
        input, select, button {
            background: #000; border: 1px solid var(--dim-green); color: var(--tactical-green);
            padding: 10px; margin: 5px 0; font-family: inherit; width: 100%;
        }
        button { cursor: pointer; font-weight: bold; border-color: var(--tactical-green); }
        button:hover { background: var(--tactical-green); color: #000; }
        .btn-admin { border-color: var(--danger-red); color: var(--danger-red); }
        .btn-admin:hover { background: var(--danger-red); color: #000; }

        /* MODAL PERFIL */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #050a05; border: 1px solid var(--tactical-green);
            margin: 10% auto; padding: 30px; width: 350px; text-align: center;
        }

        #loginBox, #panelPrincipal { display: none; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: var(--tactical-green); box-shadow: 0 0 5px var(--tactical-green); }
        .offline { background: var(--danger-red); }
    </style>
</head>
<body>

<div class="main-container">
    <div id="loginBox" class="box" style="max-width: 400px; margin: 100px auto; display: block;">
        <h2 style="text-align: center;">TERMINAL DE ACCESO</h2>
        <input id="regNombre" type="text" placeholder="NOMBRE COMPLETO">
        <input id="email" type="email" placeholder="CORREO ELECTR√ìNICO">
        <input id="password" type="password" placeholder="CONTRASE√ëA">
        <select id="division">
            <option value="Ejercito">EJ√âRCITO DE CHILE</option>
            <option value="FACH">FACH</option>
            <option value="Armada">ARMADA</option>
            <option value="BOE">BOE</option>
        </select>
        <button id="btnReg">REGISTRAR OPERATIVO</button>
        <button id="btnLogin" style="border-color: var(--alert-amber); color: var(--alert-amber);">INGRESAR</button>
    </div>

    <div id="panelPrincipal">
        <div class="stats-banner">
            <div class="stat-card"><div class="stat-num" id="countTotal">0</div><div class="stat-label">Efectivos</div></div>
            <div class="stat-card" style="border-left-color: var(--danger-red);"><div class="stat-num" id="countMando">0</div><div class="stat-label">Alto Mando</div></div>
        </div>

        <div class="box">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="welcome">CARGANDO...</h3>
                <button id="btnLogout" style="width: auto; padding: 5px 15px;">DESCONECTAR</button>
            </div>
        </div>

        <div id="adminPanel" class="box">
            <p class="admin-title">COMMAND ADMINISTRATION</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <select id="userSelectAdmin"><option value="">SELECCIONAR SOLDADO...</option></select>
                <select id="newRankAdmin"><option value="">ASIGNAR RANGO...</option></select>
                <input id="manualDays" type="number" placeholder="+ D√çAS EXTRA">
                <button id="btnApplyAdmin" class="btn-admin">APLICAR CAMBIOS</button>
            </div>
        </div>

        <div class="box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin:0;">REGISTRO T√ÅCTICO</h3>
                <input type="text" id="searchBar" placeholder="üîç FILTRAR POR NOMBRE..." onkeyup="filtrarSoldados()" style="width: 250px; margin:0;">
            </div>
            <div id="lista" class="grid-tropas"></div>
        </div>
    </div>
</div>

<div id="modalExpediente" class="modal">
    <div class="modal-content">
        <div class="icon-rank" style="margin: 0 auto 15px; width: 60px; height: 60px; font-size: 30px;">‚ñ≤</div>
        <h2 id="expNombre" style="margin:0; color: white;"></h2>
        <p id="expRangoDiv" style="color: var(--alert-amber); font-size: 12px; margin-bottom: 20px;"></p>
        
        <div style="text-align: left; background: rgba(255,255,255,0.05); padding: 15px; border: 1px solid var(--dim-green);">
            <div style="margin-bottom: 8px;">üí∞ SUELDO: <span id="expSueldo" style="color: #ffd700;"></span></div>
            <div style="margin-bottom: 8px;">‚è≥ ANTIG√úEDAD: <span id="expDias" style="color: #fff;"></span></div>
            <div style="font-size: 10px; color: #666;">√öLTIMA CONEXI√ìN: <br><span id="expCon"></span></div>
        </div>
        <button onclick="cerrarModal()" style="margin-top: 20px;">CERRAR EXPEDIENTE</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBYfZSISbpVShSfEA70vY1bANiyy40uVP4",
        authDomain: "panel-chile.firebaseapp.com",
        projectId: "panel-chile",
        storageBucket: "panel-chile.firebasestorage.app",
        messagingSenderId: "124864601883",
        appId: "1:124864601883:web:839163be2060253f68bdbe"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const RANGOS = ["Recluta", "Cabo 2¬∞", "Cabo 1¬∞", "Sargento 2¬∞", "Sargento 1¬∞", "Suboficial", "Suboficial Mayor", "Subteniente", "Teniente", "Capit√°n", "Mayor", "Teniente Coronel", "Coronel", "General de Brigada", "General de Divisi√≥n", "General en Jefe"];
    
    // SUELDOS SOLICITADOS
    const SUELDOS = {
        "Recluta": "$3.500", "Cabo 2¬∞": "$3.800", "Cabo 1¬∞": "$3.800", "Sargento 2¬∞": "$4.000",
        "Sargento 1¬∞": "$4.300", "Suboficial": "$4.600", "Suboficial Mayor": "$5.000",
        "Subteniente": "$5.300", "Teniente": "$5.700", "Capit√°n": "$6.200", "Mayor": "$6.800",
        "Teniente Coronel": "$7.500", "Coronel": "$8.500", "General de Brigada": "$9.500",
        "General de Divisi√≥n": "$11.000", "General en Jefe": "$13.000"
    };

    // Llenar select de rangos en admin
    const rankSelect = document.getElementById("newRankAdmin");
    RANGOS.forEach(r => { let o = document.createElement("option"); o.value = r; o.textContent = r; rankSelect.appendChild(o); });

    // Sonido hover
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    window.playHoverSound = () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        g.gain.setValueAtTime(0.01, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.05);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.05);
    };

    // Funci√≥n principal de carga (Corregida)
    async function cargarDatos() {
        const querySnapshot = await getDocs(collection(db, "usuarios"));
        const listaDiv = document.getElementById("lista");
        const adminUserSelect = document.getElementById("userSelectAdmin");
        
        listaDiv.innerHTML = "";
        adminUserSelect.innerHTML = '<option value="">SELECCIONAR SOLDADO...</option>';
        
        let cTotal = 0, cMando = 0;

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            cTotal++;

            if (["Coronel", "General de Brigada", "General de Divisi√≥n", "General en Jefe"].includes(data.rango)) cMando++;

            // Llenar select admin con nombres
            let opt = document.createElement("option");
            opt.value = id;
            opt.textContent = data.nombre.toUpperCase();
            adminUserSelect.appendChild(opt);

            // Generar tarjeta
            const status = (new Date() - new Date(data.ultimaConexion)) / 60000 < 15 ? "online" : "offline";
            const color = data.division === 'Ejercito' ? '#4df24d' : (data.division === 'FACH' ? '#fff' : '#00f2ff');

            listaDiv.innerHTML += `
                <div class="tarjeta-tactica" onmouseenter="playHoverSound()" onclick="verExpediente('${id}')">
                    <div style="display:flex; justify-content:space-between; font-size:9px; margin-bottom:10px;">
                        <span>${data.rango.toUpperCase()}</span>
                        <span style="color:#444;">ID-${id.substring(0,5)}</span>
                    </div>
                    <div style="display:flex; gap:15px;">
                        <div class="icon-rank" style="border-color:${color}; color:${color}">‚ñ≤</div>
                        <div style="flex:1">
                            <div style="font-weight:bold; color:white;">${data.nombre}</div>
                            <div style="font-size:10px; color:${color}">${data.division.toUpperCase()}</div>
                            <div style="font-size:10px; margin-top:5px;">
                                <span class="status-dot ${status}"></span> ${status.toUpperCase()}
                            </div>
                        </div>
                    </div>
                </div>`;
        });

        document.getElementById("countTotal").innerText = cTotal;
        document.getElementById("countMando").innerText = cMando;
    }

    window.verExpediente = async (id) => {
        const snap = await getDoc(doc(db, "usuarios", id));
        if (snap.exists()) {
            const d = snap.data();
            const diasBase = Math.floor((new Date() - new Date(d.fechaIngreso)) / 86400000);
            const diasTotal = diasBase + (parseInt(d.antiguedadManual) || 0);

            document.getElementById("expNombre").innerText = d.nombre.toUpperCase();
            document.getElementById("expRangoDiv").innerText = `${d.rango} | DIVISI√ìN ${d.division.toUpperCase()}`;
            document.getElementById("expSueldo").innerText = SUELDOS[d.rango] || "$3.500";
            document.getElementById("expDias").innerText = `${diasTotal} D√çAS`;
            document.getElementById("expCon").innerText = new Date(d.ultimaConexion).toLocaleString();
            document.getElementById("modalExpediente").style.display = "block";
        }
    };

    window.cerrarModal = () => document.getElementById("modalExpediente").style.display = "none";

    // GESTI√ìN DE SESI√ìN
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const docRef = doc(db, "usuarios", user.email);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const u = snap.data();
                document.getElementById("loginBox").style.display = "none";
                document.getElementById("panelPrincipal").style.display = "block";
                document.getElementById("welcome").innerText = `OPERATIVO: ${u.nombre.toUpperCase()}`;
                
                // Mostrar Admin si es de alto rango
                if (["Capit√°n", "Mayor", "Teniente Coronel", "Coronel", "General de Brigada", "General de Divisi√≥n", "General en Jefe"].includes(u.rango)) {
                    document.getElementById("adminPanel").style.display = "block";
                }
                
                await updateDoc(docRef, { ultimaConexion: new Date().toISOString() });
                cargarDatos();
            }
        } else {
            document.getElementById("loginBox").style.display = "block";
            document.getElementById("panelPrincipal").style.display = "none";
        }
    });

    // BOTONES
    document.getElementById("btnLogin").onclick = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value); } 
        catch(e) { alert("ERROR DE ACCESO"); }
    };

    document.getElementById("btnReg").onclick = async () => {
        const email = document.getElementById("email").value;
        const pass = document.getElementById("password").value;
        const nom = document.getElementById("regNombre").value;
        const div = document.getElementById("division").value;
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "usuarios", email), {
                nombre: nom, division: div, rango: "Recluta", fechaIngreso: new Date().toISOString(),
                antiguedadManual: 0, ultimaConexion: new Date().toISOString()
            });
            location.reload();
        } catch(e) { alert("ERROR AL REGISTRAR"); }
    };

    document.getElementById("btnApplyAdmin").onclick = async () => {
        const targetId = document.getElementById("userSelectAdmin").value;
        const nuevoRango = document.getElementById("newRankAdmin").value;
        const diasExtra = document.getElementById("manualDays").value;
        if (!targetId || !nuevoRango) return alert("SELECCIONA SOLDADO Y RANGO");
        
        await updateDoc(doc(db, "usuarios", targetId), { 
            rango: nuevoRango, 
            antiguedadManual: parseInt(diasExtra) || 0 
        });
        alert("EXPEDIENTE ACTUALIZADO CORRECTAMENTE");
        cargarDatos();
    };

    document.getElementById("btnLogout").onclick = () => signOut(auth).then(() => location.reload());

    window.filtrarSoldados = () => {
        const query = document.getElementById("searchBar").value.toLowerCase();
        const cards = document.getElementsByClassName("tarjeta-tactica");
        for (let c of cards) {
            c.style.display = c.innerText.toLowerCase().includes(query) ? "block" : "none";
        }
    };
</script>
</body>
</html>
